"use strict";(self["webpackChunktcr_system_frontend"]=self["webpackChunktcr_system_frontend"]||[]).push([[843],{843:function(e,a,l){l.r(a),l.d(a,{default:function(){return y}});var r=l(6768),s=l(4232),o=l(144),t=l(1387),d=l(1219),u=l(788),n=l.n(u),i=l(3988);const c={class:"user-profile-container"},v={class:"card-header"},m={class:"profile-content"},p={class:"avatar-section"},f={class:"avatar-display"},k=["src"],w={class:"info-section"},g={class:"password-section"};var b={__name:"UserProfile",setup(e){const a=(0,t.rd)(),l=localStorage.getItem("token"),u=(0,o.KR)(JSON.parse(localStorage.getItem("userInfo")||"{}")),b=(0,o.KR)(""),h=(0,o.KR)(!1),_=(0,o.KR)(null),y=()=>{const e=u.value.role;0===e?a.push("/student/home"):1===e?a.push("/teacher/home"):2===e?a.push("/admin/home"):a.push("/login")},P=e=>e?e.startsWith("http")?e:`http://localhost:8080${e}`:"",W=(0,o.Kh)({oldPassword:"",newPassword:"",confirmPassword:""}),F=(e,a,l)=>{""===a?l(new Error("请输入密码")):(""!==W.confirmPassword&&_.value.validateField("confirmPassword"),l())},I=(e,a,l)=>{""===a?l(new Error("请再次输入密码")):a!==W.newPassword?l(new Error("两次输入密码不一致!")):l()},N={oldPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{validator:F,trigger:"blur"},{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:I,trigger:"blur"}]},R=e=>{const a="image/jpeg"===e.type||"image/png"===e.type,l=e.size/1024/1024<2;return a?!!l||(d.nk.error("头像大小不能超过2MB!"),!1):(d.nk.error("头像只能是JPG或PNG格式!"),!1)},V=e=>{if(200===e.code){const a=e.data;b.value=P(a);const l={...u.value,avatar:a};localStorage.setItem("userInfo",JSON.stringify(l)),u.value=l,d.nk.success("头像上传成功")}else d.nk.error(e.message||"头像上传失败")},L=async()=>{await _.value.validate((async e=>{if(e){h.value=!0;try{const e=await n().post("/api/user/change-password",{oldPassword:W.oldPassword,newPassword:W.newPassword},{headers:{Authorization:l}});200===e.data.code?(d.nk.success("密码修改成功，请重新登录"),setTimeout((()=>{localStorage.removeItem("token"),localStorage.removeItem("userInfo"),a.push("/login")}),1500)):d.nk.error(e.data.message||"密码修改失败")}catch(r){console.error("密码修改出错:",r),d.nk.error("密码修改失败，请稍后重试")}finally{h.value=!1}}}))},S=async()=>{try{const e=await n().get("/api/user/profile",{headers:{Authorization:l}});200===e.data.code&&(u.value=e.data.data,localStorage.setItem("userInfo",JSON.stringify(e.data.data)),e.data.data.avatar&&(b.value=P(e.data.data.avatar)))}catch(e){console.error("获取用户信息出错:",e)}};return(0,r.sV)((()=>{S()})),(e,a)=>{const t=(0,r.g2)("el-button"),d=(0,r.g2)("el-avatar"),n=(0,r.g2)("el-upload"),P=(0,r.g2)("el-descriptions-item"),F=(0,r.g2)("el-descriptions"),I=(0,r.g2)("el-input"),S=(0,r.g2)("el-form-item"),X=(0,r.g2)("el-form"),G=(0,r.g2)("el-card");return(0,r.uX)(),(0,r.CE)("div",c,[(0,r.bF)(G,{class:"profile-card"},{header:(0,r.k6)((()=>[(0,r.Lk)("div",v,[a[4]||(a[4]=(0,r.Lk)("h2",null,"个人信息",-1)),(0,r.bF)(t,{type:"primary",size:"small",onClick:y},{default:(0,r.k6)((()=>a[3]||(a[3]=[(0,r.eW)("返回首页")]))),_:1})])])),default:(0,r.k6)((()=>[(0,r.Lk)("div",m,[(0,r.Lk)("div",p,[(0,r.Lk)("div",f,[b.value?((0,r.uX)(),(0,r.CE)("img",{key:0,src:b.value,class:"avatar",alt:"用户头像"},null,8,k)):((0,r.uX)(),(0,r.Wv)(d,{key:1,size:100,class:"user-avatar"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.realName?.substring(0,1)||u.value.username?.substring(0,1)||"U"),1)])),_:1}))]),(0,r.bF)(n,(0,r.v6)({class:"avatar-uploader",action:"/api/user/upload-avatar",headers:{Authorization:(0,o.R1)(l)},"show-file-list":!1,"on-success":V,"before-upload":R},(0,o.R1)(i.G)),{default:(0,r.k6)((()=>[(0,r.bF)(t,{size:"small",type:"primary",class:"upload-button"},{default:(0,r.k6)((()=>a[5]||(a[5]=[(0,r.eW)("上传新头像")]))),_:1})])),_:1},16,["headers"]),a[6]||(a[6]=(0,r.Lk)("div",{class:"upload-hint"},"支持JPG、PNG格式，大小不超过2MB",-1))]),(0,r.Lk)("div",w,[(0,r.bF)(F,{column:1,border:""},{default:(0,r.k6)((()=>[0===u.value.role?((0,r.uX)(),(0,r.Wv)(P,{key:0,label:"学号"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.studentId||u.value.username),1)])),_:1})):1===u.value.role?((0,r.uX)(),(0,r.Wv)(P,{key:1,label:"工号"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.teacherId||u.value.username),1)])),_:1})):((0,r.uX)(),(0,r.Wv)(P,{key:2,label:"用户名"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.username),1)])),_:1})),(0,r.bF)(P,{label:"姓名"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.realName||"未设置"),1)])),_:1}),(0,r.bF)(P,{label:"角色"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(0===u.value.role?"学生":1===u.value.role?"教师":"管理员"),1)])),_:1}),0===u.value.role?((0,r.uX)(),(0,r.Wv)(P,{key:3,label:"班级"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.className||"未设置"),1)])),_:1})):(0,r.Q3)("",!0),0===u.value.role?((0,r.uX)(),(0,r.Wv)(P,{key:4,label:"专业"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.majorName||"未设置"),1)])),_:1})):(0,r.Q3)("",!0),0===u.value.role?((0,r.uX)(),(0,r.Wv)(P,{key:5,label:"学院"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.collegeName||"未设置"),1)])),_:1})):(0,r.Q3)("",!0),(0,r.bF)(P,{label:"邮箱"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(u.value.email||"未设置"),1)])),_:1})])),_:1})])]),(0,r.Lk)("div",g,[a[8]||(a[8]=(0,r.Lk)("h3",null,"修改密码",-1)),(0,r.bF)(X,{model:W,rules:N,ref_key:"passwordFormRef",ref:_,"label-width":"120px","status-icon":""},{default:(0,r.k6)((()=>[(0,r.bF)(S,{label:"当前密码",prop:"oldPassword"},{default:(0,r.k6)((()=>[(0,r.bF)(I,(0,r.v6)({modelValue:W.oldPassword,"onUpdate:modelValue":a[0]||(a[0]=e=>W.oldPassword=e),type:"password","show-password":"",placeholder:"请输入当前密码"},(0,o.R1)(i.G)),null,16,["modelValue"])])),_:1}),(0,r.bF)(S,{label:"新密码",prop:"newPassword"},{default:(0,r.k6)((()=>[(0,r.bF)(I,(0,r.v6)({modelValue:W.newPassword,"onUpdate:modelValue":a[1]||(a[1]=e=>W.newPassword=e),type:"password","show-password":"",placeholder:"请输入新密码"},(0,o.R1)(i.G)),null,16,["modelValue"])])),_:1}),(0,r.bF)(S,{label:"确认新密码",prop:"confirmPassword"},{default:(0,r.k6)((()=>[(0,r.bF)(I,(0,r.v6)({modelValue:W.confirmPassword,"onUpdate:modelValue":a[2]||(a[2]=e=>W.confirmPassword=e),type:"password","show-password":"",placeholder:"请再次输入新密码"},(0,o.R1)(i.G)),null,16,["modelValue"])])),_:1}),(0,r.bF)(S,null,{default:(0,r.k6)((()=>[(0,r.bF)(t,{type:"primary",onClick:L,loading:h.value},{default:(0,r.k6)((()=>a[7]||(a[7]=[(0,r.eW)("修改密码")]))),_:1},8,["loading"])])),_:1})])),_:1},8,["model"])])])),_:1})])}}},h=l(1241);const _=(0,h.A)(b,[["__scopeId","data-v-c771c5b8"]]);var y=_}}]);
//# sourceMappingURL=843.5565b37f.js.map