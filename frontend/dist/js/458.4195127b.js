"use strict";(self["webpackChunktcr_system_frontend"]=self["webpackChunktcr_system_frontend"]||[]).push([[458],{4458:function(e,a,t){t.r(a),t.d(a,{default:function(){return F}});var l=t(6768),r=t(4232);const i={class:"material-review"},n={class:"filter-container"},o={class:"pagination-container"},s={key:0},d={class:"file-info"},c={class:"review-records"},u={key:0,class:"review-actions"};function m(e,a,t,m,p,v){const b=(0,l.g2)("el-option"),w=(0,l.g2)("el-select"),f=(0,l.g2)("el-form-item"),_=(0,l.g2)("el-button"),g=(0,l.g2)("el-form"),k=(0,l.g2)("el-table-column"),F=(0,l.g2)("el-tag"),h=(0,l.g2)("el-table"),y=(0,l.g2)("el-pagination"),C=(0,l.g2)("el-card"),D=(0,l.g2)("el-descriptions-item"),x=(0,l.g2)("el-descriptions"),R=(0,l.g2)("el-divider"),I=(0,l.g2)("el-input"),W=(0,l.g2)("el-dialog"),V=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",i,[(0,l.bF)(C,{class:"box-card"},{header:(0,l.k6)((()=>a[8]||(a[8]=[(0,l.Lk)("div",{class:"card-header"},[(0,l.Lk)("span",null,"教学材料审核")],-1)]))),default:(0,l.k6)((()=>[(0,l.Lk)("div",n,[(0,l.bF)(g,{inline:!0,model:m.queryParams,class:"demo-form-inline"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"学年"},{default:(0,l.k6)((()=>[(0,l.bF)(w,(0,l.v6)({modelValue:m.queryParams.academicYear,"onUpdate:modelValue":a[0]||(a[0]=e=>m.queryParams.academicYear=e),placeholder:"请选择学年",clearable:"",style:{width:"250px"}},m.safeElementConfig),{default:(0,l.k6)((()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(m.academicYears,(e=>((0,l.uX)(),(0,l.Wv)(b,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},16,["modelValue"])])),_:1}),(0,l.bF)(f,{label:"学期"},{default:(0,l.k6)((()=>[(0,l.bF)(w,(0,l.v6)({modelValue:m.queryParams.semester,"onUpdate:modelValue":a[1]||(a[1]=e=>m.queryParams.semester=e),placeholder:"请选择学期",clearable:"",style:{width:"250px"}},m.safeElementConfig),{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"第一学期",value:1}),(0,l.bF)(b,{label:"第二学期",value:2})])),_:1},16,["modelValue"])])),_:1}),(0,l.bF)(f,{label:"状态"},{default:(0,l.k6)((()=>[(0,l.bF)(w,(0,l.v6)({modelValue:m.queryParams.status,"onUpdate:modelValue":a[2]||(a[2]=e=>m.queryParams.status=e),placeholder:"请选择状态",clearable:"",style:{width:"250px"}},m.safeElementConfig),{default:(0,l.k6)((()=>[(0,l.bF)(b,{label:"待审核",value:0}),(0,l.bF)(b,{label:"课程负责人审核中",value:1}),(0,l.bF)(b,{label:"专业负责人审核中",value:2}),(0,l.bF)(b,{label:"副院长审核中",value:3}),(0,l.bF)(b,{label:"教务人员审核中",value:4}),(0,l.bF)(b,{label:"审核通过",value:5}),(0,l.bF)(b,{label:"审核不通过",value:6})])),_:1},16,["modelValue"])])),_:1}),(0,l.bF)(f,null,{default:(0,l.k6)((()=>[(0,l.bF)(_,{type:"primary",onClick:m.fetchReviews},{default:(0,l.k6)((()=>a[9]||(a[9]=[(0,l.eW)("查询")]))),_:1},8,["onClick"])])),_:1})])),_:1},8,["model"])]),(0,l.bo)(((0,l.uX)(),(0,l.Wv)(h,{data:m.reviews,style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(k,{prop:"material_name",label:"材料名称",width:"180"}),(0,l.bF)(k,{prop:"course_name",label:"所属课程",width:"180"}),(0,l.bF)(k,{prop:"material_type_name",label:"材料类型"}),(0,l.bF)(k,{prop:"academic_year",label:"学年"}),(0,l.bF)(k,{prop:"semester",label:"学期"},{default:(0,l.k6)((e=>[(0,l.eW)((0,r.v_)(1===e.row.semester?"第一学期":"第二学期"),1)])),_:1}),(0,l.bF)(k,{prop:"submit_user_name",label:"提交人"}),(0,l.bF)(k,{prop:"status",label:"状态"},{default:(0,l.k6)((e=>[(0,l.bF)(F,{type:m.getStatusType(e.row.status)},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.getStatusText(e.row.status)),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(k,{prop:"create_time",label:"提交时间"}),(0,l.bF)(k,{label:"操作",width:"150"},{default:(0,l.k6)((e=>[(0,l.bF)(_,{type:"text",size:"small",onClick:a=>m.viewReviewDetail(e.row.id)},{default:(0,l.k6)((()=>a[10]||(a[10]=[(0,l.eW)("查看详情")]))),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[V,m.loading]]),(0,l.Lk)("div",o,[(0,l.bF)(y,{background:"",layout:"total, prev, pager, next",total:m.total,"page-size":m.queryParams.size,"current-page":m.queryParams.current,onCurrentChange:m.handleCurrentChange},null,8,["total","page-size","current-page","onCurrentChange"])])])),_:1}),(0,l.bF)(W,(0,l.v6)({title:"审核详情",modelValue:m.detailDialogVisible,"onUpdate:modelValue":a[7]||(a[7]=e=>m.detailDialogVisible=e),width:"60%"},m.safeElementConfig),{default:(0,l.k6)((()=>[m.reviewDetail?((0,l.uX)(),(0,l.CE)("div",s,[(0,l.bF)(x,{column:2,border:""},{default:(0,l.k6)((()=>[(0,l.bF)(D,{label:"材料名称"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.material_name),1)])),_:1}),(0,l.bF)(D,{label:"所属课程"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.course_name),1)])),_:1}),(0,l.bF)(D,{label:"材料类型"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.material_type_name),1)])),_:1}),(0,l.bF)(D,{label:"学年/学期"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.academic_year)+" / "+(0,r.v_)(1===m.reviewDetail.semester?"第一学期":"第二学期"),1)])),_:1}),(0,l.bF)(D,{label:"提交人"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.submit_user_name),1)])),_:1}),(0,l.bF)(D,{label:"提交时间"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.create_time),1)])),_:1}),(0,l.bF)(D,{label:"当前状态"},{default:(0,l.k6)((()=>[(0,l.bF)(F,{type:m.getStatusType(m.reviewDetail.status)},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.getStatusText(m.reviewDetail.status)),1)])),_:1},8,["type"])])),_:1}),(0,l.bF)(D,{label:"当前审核人"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.current_reviewer_name),1)])),_:1}),(0,l.bF)(D,{label:"材料描述",span:2},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(m.reviewDetail.material_description),1)])),_:1})])),_:1}),(0,l.Lk)("div",d,[a[12]||(a[12]=(0,l.Lk)("h3",null,"材料文件",-1)),(0,l.Lk)("p",null,"文件名："+(0,r.v_)(m.reviewDetail.material_name),1),(0,l.Lk)("p",null,"文件大小："+(0,r.v_)(m.formatFileSize(m.reviewDetail.file_size)),1),(0,l.Lk)("p",null,"文件类型："+(0,r.v_)(m.reviewDetail.file_type),1),(0,l.bF)(_,{type:"primary",size:"small",onClick:a[3]||(a[3]=e=>m.downloadFile(m.reviewDetail.material_id))},{default:(0,l.k6)((()=>a[11]||(a[11]=[(0,l.eW)("下载文件")]))),_:1})]),(0,l.Lk)("div",c,[a[13]||(a[13]=(0,l.Lk)("h3",null,"审核记录",-1)),(0,l.bF)(h,{data:m.reviewRecords,style:{width:"100%"}},{default:(0,l.k6)((()=>[(0,l.bF)(k,{prop:"reviewer_name",label:"审核人",width:"120"}),(0,l.bF)(k,{prop:"reviewer_title",label:"审核人职称",width:"120"},{default:(0,l.k6)((e=>[(0,l.eW)((0,r.v_)(m.getReviewerTitleText(e.row.reviewer_title)),1)])),_:1}),(0,l.bF)(k,{prop:"result",label:"审核结果",width:"100"},{default:(0,l.k6)((e=>[(0,l.bF)(F,{type:1===e.row.result?"success":"danger"},{default:(0,l.k6)((()=>[(0,l.eW)((0,r.v_)(1===e.row.result?"通过":"不通过"),1)])),_:2},1032,["type"])])),_:1}),(0,l.bF)(k,{prop:"comment",label:"审核意见"}),(0,l.bF)(k,{prop:"create_time",label:"审核时间",width:"180"})])),_:1},8,["data"])]),5!==m.reviewDetail.status&&6!==m.reviewDetail.status?((0,l.uX)(),(0,l.CE)("div",u,[(0,l.bF)(R),a[16]||(a[16]=(0,l.Lk)("h3",null,"审核操作",-1)),(0,l.bF)(g,{model:m.reviewForm,"label-width":"100px"},{default:(0,l.k6)((()=>[(0,l.bF)(f,{label:"审核意见"},{default:(0,l.k6)((()=>[(0,l.bF)(I,{modelValue:m.reviewForm.comment,"onUpdate:modelValue":a[4]||(a[4]=e=>m.reviewForm.comment=e),type:"textarea",rows:3,placeholder:"请输入审核意见"},null,8,["modelValue"])])),_:1}),(0,l.bF)(f,null,{default:(0,l.k6)((()=>[(0,l.bF)(_,{type:"success",onClick:a[5]||(a[5]=e=>m.handleReview(1))},{default:(0,l.k6)((()=>a[14]||(a[14]=[(0,l.eW)("通过")]))),_:1}),(0,l.bF)(_,{type:"danger",onClick:a[6]||(a[6]=e=>m.handleReview(0))},{default:(0,l.k6)((()=>a[15]||(a[15]=[(0,l.eW)("不通过")]))),_:1})])),_:1})])),_:1},8,["model"])])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)])),_:1},16,["modelValue"])])}var p=t(144),v=t(1219),b=t(788),w=t.n(b),f=t(3988),_={name:"AdminMaterialReview",setup(){const e=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!e.id)return void v.nk.error("未获取到用户信息，请重新登录");const a=(0,p.KR)([]),t=()=>{const e=(new Date).getFullYear(),t=[];for(let a=0;a<5;a++){const l=e-a;t.push(`${l}-${l+1}`)}a.value=t},r=(0,p.Kh)({current:1,size:10,academicYear:null,semester:null,status:null}),i=(0,p.KR)([]),n=(0,p.KR)(0),o=(0,p.KR)(!1),s=async()=>{o.value=!0;try{const e=await w().get("/api/material-review/admin/list",{params:r});e.data&&e.data.data?(i.value=e.data.data.records||[],n.value=e.data.data.total||0):(i.value=[],n.value=0)}catch(e){console.error("获取审核列表失败",e),v.nk.error("获取审核列表失败"),i.value=[],n.value=0}finally{o.value=!1}},d=e=>{r.current=e,s()},c=(0,p.KR)(!1),u=(0,p.KR)(null),m=(0,p.KR)([]),b=async e=>{try{const a=await w().get(`/api/material-review/detail/${e}`);if(a.data&&a.data.data){u.value=a.data.data;const t=await w().get(`/api/material-review/records/${e}`);t.data&&t.data.data?m.value=t.data.data||[]:m.value=[],c.value=!0}else v.nk.error("获取审核详情失败")}catch(a){console.error("获取审核详情失败",a),v.nk.error("获取审核详情失败"),m.value=[]}},_=e=>{switch(e){case 0:return"待审核";case 1:return"课程负责人审核中";case 2:return"专业负责人审核中";case 3:return"副院长审核中";case 4:return"教务人员审核中";case 5:return"审核通过";case 6:return"审核不通过";default:return"未知状态"}},g=e=>{switch(e){case 0:return"info";case 1:case 2:case 3:case 4:return"warning";case 5:return"success";case 6:return"danger";default:return"info"}},k=e=>{switch(e){case 0:return"普通教师";case 1:return"课程负责人";case 2:return"专业负责人";case 3:return"副院长";case 4:return"教务人员";default:return"未知职称"}},F=e=>{if(!e)return"0 B";const a=["B","KB","MB","GB","TB"];let t=0,l=e;while(l>=1024&&t<a.length-1)l/=1024,t++;return l.toFixed(2)+" "+a[t]},h=async e=>{if(e)try{console.log(`开始下载材料，ID: ${e}`);const t=await w().get(`/api/material/download/${e}`,{responseType:"blob"});console.log("下载响应头:",t.headers);const l=new Blob([t.data]),r=window.URL.createObjectURL(l),i=document.createElement("a");i.href=r;const n=t.headers["content-disposition"];console.log("Content-Disposition头:",n);let o=u.value?.material_name||"下载文件";const s=u.value?.file_type||"";s&&!o.toLowerCase().endsWith("."+s.toLowerCase())&&(o+="."+s);let d=o;if(n){const e=n.match(/filename\*=UTF-8''([^;]+)/i);if(e&&e[1])try{d=decodeURIComponent(e[1]),console.log("从filename*参数解析的文件名:",d)}catch(a){console.error("解码filename*参数出错:",a)}else{const e=n.match(/filename=(?:"([^"]+)"|([^;]+))/i);if(e){const t=e[1]||e[2];if(t)try{d=decodeURIComponent(t),console.log("从filename参数解析的文件名:",d)}catch(a){d=t,console.log("使用未解码的filename参数:",d)}}}}else console.warn("响应头中缺少Content-Disposition");const c=t.headers["content-type"];if(c&&!d.includes(".")){const e=D(c);e&&(d+=e,console.log(`根据Content-Type添加扩展名: ${e}, 最终文件名: ${d}`))}console.log("最终下载文件名:",d),i.download=d,document.body.appendChild(i),i.click(),setTimeout((()=>{window.URL.revokeObjectURL(r),document.body.removeChild(i)}),100),w().post(`/api/material/download/${e}`).catch((e=>console.error("更新下载次数失败:",e))),v.nk.success("文件下载成功")}catch(a){console.error("下载文件失败:",a),v.nk.error("下载文件失败")}else v.nk.warning("材料ID为空")},y=(0,p.KR)({comment:""}),C=async e=>{if(!y.value.comment)return void v.nk.warning("请输入审核意见");const a=JSON.parse(localStorage.getItem("userInfo")||"{}");if(a.id)try{const t=parseInt(a.role||"0");let l=0;if(2===t)l=4;else{const e=parseInt(u.value.status);switch(e){case 1:l=1;break;case 2:l=2;break;case 3:l=3;break;case 4:l=4;break}}console.log("发送审核请求，参数：",{reviewId:parseInt(u.value.id),reviewerId:parseInt(a.id),reviewerTitle:parseInt(l),result:parseInt(e),comment:y.value.comment});const r=await w().post("/api/material-review/review",{reviewId:parseInt(u.value.id),reviewerId:parseInt(a.id),reviewerTitle:parseInt(l),result:parseInt(e),comment:y.value.comment});r.data&&200===r.data.code?(v.nk.success("审核操作成功"),c.value=!1,s()):v.nk.error(r.data.message||"审核操作失败")}catch(t){console.error("审核操作失败",t),v.nk.error("审核操作失败")}else v.nk.error("未获取到用户信息，请重新登录")},D=e=>{const a={"application/pdf":".pdf","application/msword":".doc","application/vnd.openxmlformats-officedocument.wordprocessingml.document":".docx","application/vnd.ms-excel":".xls","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":".xlsx","application/vnd.ms-powerpoint":".ppt","application/vnd.openxmlformats-officedocument.presentationml.presentation":".pptx","text/plain":".txt","image/jpeg":".jpg","image/png":".png","image/gif":".gif","application/zip":".zip","application/x-rar-compressed":".rar","application/x-7z-compressed":".7z"};return a[e]||""};return(0,l.sV)((()=>{t(),s()})),{academicYears:a,queryParams:r,reviews:i,total:n,loading:o,fetchReviews:s,handleCurrentChange:d,detailDialogVisible:c,reviewDetail:u,reviewRecords:m,viewReviewDetail:b,getStatusText:_,getStatusType:g,getReviewerTitleText:k,formatFileSize:F,downloadFile:h,reviewForm:y,handleReview:C,getExtensionFromMimeType:D,safeElementConfig:f.G}}},g=t(1241);const k=(0,g.A)(_,[["render",m],["__scopeId","data-v-6dd821b2"]]);var F=k}}]);
//# sourceMappingURL=458.4195127b.js.map