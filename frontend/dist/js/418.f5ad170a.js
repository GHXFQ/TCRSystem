"use strict";(self["webpackChunktcr_system_frontend"]=self["webpackChunktcr_system_frontend"]||[]).push([[418],{5418:function(e,a,l){l.r(a),l.d(a,{default:function(){return h}});var t=l(6768),r=l(4232),o=l(144),n=l(1219),s=l(2933),u=l(788),d=l.n(u);const c={class:"resource-sharing-container"},i={class:"sync-actions"},m={key:0,class:"sync-tip"},p={class:"card-header"},v={key:0,class:"materials-tip"},b={class:"pagination-container"};var k={__name:"ResourceSharing",setup(e){const a=(0,o.KR)(!1),l=(0,o.KR)([]),u=(0,o.KR)([]),k=(0,o.KR)([]),y=(0,o.KR)([]),g=(0,o.KR)(0),h=(0,o.KR)({}),_=(0,o.KR)(null),f=(0,o.KR)([]),w=(0,o.Kh)({current:1,pageSize:10,courseId:null,academicYear:null,semester:null,materialTypeId:null}),F=(0,t.EW)((()=>!!w.courseId&&l.value.some((e=>e.course_id===w.courseId&&e.upload_user_id!==_.value)))),I=(0,t.EW)((()=>!!w.courseId)),C=async()=>{try{const e=JSON.parse(localStorage.getItem("userInfo")||"{}");if(_.value=e.id,!_.value)return void n.nk.warning("无法获取用户信息，请重新登录");const a=await d().get(`/api/course/teacher/${_.value}`);u.value=a.data.data||[],u.value.forEach((e=>{h.value[e.id]=e,f.value.push(e.id)}))}catch(e){console.error("获取教师课程失败:",e),n.nk.error("获取教师课程失败")}},W=async()=>{try{const e=await d().get("/api/material-type/list");k.value=e.data.data||[]}catch(e){console.error("获取材料类型失败:",e),n.nk.error("获取材料类型失败")}},$=()=>{const e=(new Date).getFullYear(),a=[];for(let l=0;l<5;l++){const t=e-l;a.push(`${t}-${t+1}`)}y.value=a},K=async()=>{a.value=!0;try{const e={...w};!e.courseId&&f.value.length>0&&(e.courseIdsStr=f.value.join(",")),null!==e.semester&&void 0!==e.semester&&(e.semester=Number(e.semester)),null!==e.materialTypeId&&void 0!==e.materialTypeId&&(e.materialTypeId=Number(e.materialTypeId)),console.log("查询参数：",e);const a=await d().get("/api/material/shared",{params:e});if(200===a.data.code){const e=a.data.data.records||[];l.value=e.map((e=>({...e,material_type_name:e.material_type_name||"未知类型",course_name:e.course_name||"未知课程",academic_year:e.academic_year||"未知学年",semester:e.semester?Number(e.semester):null}))),g.value=a.data.data.total||0,console.log("获取到的材料列表:",l.value),l.value.length>0&&(console.log("第一条材料数据样例:",l.value[0]),console.log("材料类型名称:",l.value[0].material_type_name),console.log("学年:",l.value[0].academic_year),console.log("学期:",l.value[0].semester,"类型:",typeof l.value[0].semester)),w.courseId&&console.log("检查材料：",l.value)}else n.nk.error(a.data.message||"获取教学资源失败")}catch(e){console.error("获取教学资源失败:",e),n.nk.error("获取教学资源失败："+(e.response?.data?.message||e.message||"未知错误"))}finally{a.value=!1}},T=()=>{w.courseId=null,w.academicYear=null,w.semester=null,w.materialTypeId=null,w.current=1,K()},V=()=>{w.current=1,K()},X=e=>{w.current=e,K()},E=e=>{w.pageSize=e,w.current=1,K()},R=e=>{if(e.id)try{const a=`/api/material/download/${e.id}`,l=document.createElement("a");l.href=a,l.setAttribute("download",""),document.body.appendChild(l),l.click(),setTimeout((()=>{document.body.removeChild(l)}),100),d().post(`/api/material/download/${e.id}`).catch((e=>console.error("更新下载次数失败:",e))),n.nk.success("开始下载文件")}catch(a){console.error("下载文件失败:",a),n.nk.error("下载文件失败")}else n.nk.warning("材料ID为空")},x=async e=>{if(w.courseId)try{a.value=!0;const l=k.value.find((a=>a.name===e))?.id;if(!l)return void n.nk.warning(`未找到${e}材料类型`);const t={courseId:w.courseId,materialTypeId:l,excludeUserId:_.value},r=await d().get("/api/material/course-shared",{params:t}),o=r.data.data||[];if(!o.length)return void n.nk.warning(`当前课程没有其他教师上传的${e}`);await s.s.confirm(`确定要同步本课程的${e}吗？共${o.length}份资料将被下载。`,"确认同步",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),n.nk.success(`正在同步${o.length}份${e}资料，请在弹出的窗口中查看`);for(let e=0;e<o.length;e++)setTimeout((()=>{const a=`/api/material/download/${o[e].id}`;window.open(a,"_blank"),d().post(`/api/material/download/${o[e].id}`).catch((e=>console.error("更新下载次数失败:",e)))}),1e3*e)}catch(l){"cancel"!==l&&(console.error(`同步${e}失败:`,l),n.nk.error(`同步${e}失败`))}finally{a.value=!1}else n.nk.warning("请先选择课程")};return(0,t.sV)((()=>{C(),W(),$(),K()})),(e,o)=>{const n=(0,t.g2)("el-option"),s=(0,t.g2)("el-select"),d=(0,t.g2)("el-form-item"),_=(0,t.g2)("el-button"),f=(0,t.g2)("el-form"),C=(0,t.g2)("el-card"),W=(0,t.g2)("el-alert"),$=(0,t.g2)("el-tag"),z=(0,t.g2)("el-empty"),S=(0,t.g2)("el-table-column"),L=(0,t.g2)("el-table"),D=(0,t.g2)("el-pagination"),N=(0,t.gN)("loading");return(0,t.uX)(),(0,t.CE)("div",c,[o[12]||(o[12]=(0,t.Lk)("h1",null,"课程资源协同",-1)),(0,t.bF)(C,{class:"filter-card"},{header:(0,t.k6)((()=>o[6]||(o[6]=[(0,t.Lk)("div",{class:"card-header"},[(0,t.Lk)("span",null,"查询与下载")],-1)]))),default:(0,t.k6)((()=>[(0,t.bF)(f,{inline:!0,model:w,class:"filter-form"},{default:(0,t.k6)((()=>[(0,t.bF)(d,{label:"课程"},{default:(0,t.k6)((()=>[(0,t.bF)(s,{modelValue:w.courseId,"onUpdate:modelValue":o[0]||(o[0]=e=>w.courseId=e),placeholder:"选择课程",clearable:"",filterable:"",style:{width:"220px"},onChange:V},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(u.value,(e=>((0,t.uX)(),(0,t.Wv)(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,t.bF)(d,{label:"学年"},{default:(0,t.k6)((()=>[(0,t.bF)(s,{modelValue:w.academicYear,"onUpdate:modelValue":o[1]||(o[1]=e=>w.academicYear=e),placeholder:"选择学年",clearable:"",style:{width:"150px"}},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(y.value,(e=>((0,t.uX)(),(0,t.Wv)(n,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,t.bF)(d,{label:"学期"},{default:(0,t.k6)((()=>[(0,t.bF)(s,{modelValue:w.semester,"onUpdate:modelValue":o[2]||(o[2]=e=>w.semester=e),placeholder:"选择学期",clearable:"",style:{width:"150px"}},{default:(0,t.k6)((()=>[(0,t.bF)(n,{label:"第一学期",value:1}),(0,t.bF)(n,{label:"第二学期",value:2})])),_:1},8,["modelValue"])])),_:1}),(0,t.bF)(d,{label:"材料类型"},{default:(0,t.k6)((()=>[(0,t.bF)(s,{modelValue:w.materialTypeId,"onUpdate:modelValue":o[3]||(o[3]=e=>w.materialTypeId=e),placeholder:"选择材料类型",clearable:"",style:{width:"150px"}},{default:(0,t.k6)((()=>[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(k.value,(e=>((0,t.uX)(),(0,t.Wv)(n,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,t.bF)(d,null,{default:(0,t.k6)((()=>[(0,t.bF)(_,{type:"primary",onClick:K},{default:(0,t.k6)((()=>o[7]||(o[7]=[(0,t.eW)("查询")]))),_:1}),(0,t.bF)(_,{onClick:T},{default:(0,t.k6)((()=>o[8]||(o[8]=[(0,t.eW)("重置")]))),_:1})])),_:1})])),_:1},8,["model"])])),_:1}),w.courseId?((0,t.uX)(),(0,t.Wv)(C,{key:0,class:"sync-card"},{default:(0,t.k6)((()=>[(0,t.Lk)("div",i,[(0,t.bF)(_,{type:"primary",icon:"Download",onClick:o[4]||(o[4]=e=>x("教学大纲")),disabled:!F.value},{default:(0,t.k6)((()=>o[9]||(o[9]=[(0,t.eW)(" 同步本课程教学大纲 ")]))),_:1},8,["disabled"]),(0,t.bF)(_,{type:"success",icon:"Download",onClick:o[5]||(o[5]=e=>x("授课计划")),disabled:!F.value},{default:(0,t.k6)((()=>o[10]||(o[10]=[(0,t.eW)(" 同步本课程授课计划 ")]))),_:1},8,["disabled"])]),w.courseId&&!F.value?((0,t.uX)(),(0,t.CE)("div",m,[(0,t.bF)(W,{title:"当前课程暂无其他教师上传的教学大纲或授课计划",type:"info","show-icon":"",closable:!1})])):(0,t.Q3)("",!0)])),_:1})):(0,t.Q3)("",!0),(0,t.bo)(((0,t.uX)(),(0,t.Wv)(C,{class:"materials-card"},{header:(0,t.k6)((()=>[(0,t.Lk)("div",p,[(0,t.Lk)("span",null,(0,r.v_)(w.courseId&&h.value[w.courseId]?.name||"所有课程")+" 教学资源 ",1),I.value?((0,t.uX)(),(0,t.Wv)($,{key:0,type:"success"},{default:(0,t.k6)((()=>o[11]||(o[11]=[(0,t.eW)("仅显示同课程教师的材料")]))),_:1})):(0,t.Q3)("",!0)])])),default:(0,t.k6)((()=>[l.value.length||a.value?((0,t.uX)(),(0,t.Wv)(L,{key:1,data:l.value,style:{width:"100%"},border:""},{default:(0,t.k6)((()=>[(0,t.bF)(S,{prop:"name",label:"材料名称","min-width":"180","show-overflow-tooltip":""}),(0,t.bF)(S,{prop:"course_name",label:"所属课程",width:"150","show-overflow-tooltip":""}),(0,t.bF)(S,{prop:"material_type_name",label:"材料类型",width:"120"},{default:(0,t.k6)((e=>[(0,t.eW)((0,r.v_)(e.row.material_type_name||"未知类型"),1)])),_:1}),(0,t.bF)(S,{prop:"academic_year",label:"学年",width:"100"},{default:(0,t.k6)((e=>[(0,t.eW)((0,r.v_)(e.row.academic_year||"未知学年"),1)])),_:1}),(0,t.bF)(S,{prop:"semester",label:"学期",width:"80"},{default:(0,t.k6)((e=>[(0,t.eW)((0,r.v_)(1===e.row.semester?"第一学期":2===e.row.semester?"第二学期":"未知学期"),1)])),_:1}),(0,t.bF)(S,{prop:"description",label:"描述","min-width":"150","show-overflow-tooltip":""}),(0,t.bF)(S,{prop:"upload_user_name",label:"上传教师",width:"120"}),(0,t.bF)(S,{prop:"create_time",label:"上传时间",width:"180"}),(0,t.bF)(S,{label:"操作",width:"120",fixed:"right"},{default:(0,t.k6)((e=>[(0,t.bF)(_,{type:"primary",size:"small",icon:"Download",circle:"",plain:"",onClick:a=>R(e.row),title:"下载"},null,8,["onClick"])])),_:1})])),_:1},8,["data"])):((0,t.uX)(),(0,t.CE)("div",v,[(0,t.bF)(z,{description:"暂无符合条件的教学资源"})])),(0,t.Lk)("div",b,[(0,t.bF)(D,{background:"",layout:"total, sizes, prev, pager, next, jumper",total:g.value,"page-sizes":[10,20,50,100],"page-size":w.pageSize,"current-page":w.current,onSizeChange:E,onCurrentChange:X},null,8,["total","page-size","current-page"])])])),_:1})),[[N,a.value]])])}}},y=l(1241);const g=(0,y.A)(k,[["__scopeId","data-v-6902cbd9"]]);var h=g}}]);
//# sourceMappingURL=418.f5ad170a.js.map